<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
    

<title>Data Migration - part 1</title>

        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.b3df.png">
      <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.a84d.png">
      <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.664d.png">
      <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.faf5.png">
      <link rel="apple-touch-icon" sizes="114x114" href=/"images/favicons/apple-touch-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.d810.png">
      <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.1807.png">
      <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.71bf.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.a9f0.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.e5f8.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.0b72.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.7353.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.5ad2.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface&text=gizra' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


      <!-- Begin Inspectlet Embed Code -->
      <script type="text/javascript" id="inspectletjs">
      window.__insp = window.__insp || [];
      __insp.push(['wid', 314054580]);
      (function() {
      function ldinsp(){if(typeof window.__inspld != "undefined") return; window.__inspld = 1; var insp = document.createElement('script'); insp.type = 'text/javascript'; insp.async = true; insp.id = "inspsync"; insp.src = ('https:' == document.location.protocol ? 'https' : 'http') + '://cdn.inspectlet.com/inspectlet.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(insp, x); };
      setTimeout(ldinsp, 500); document.readyState != "complete" ? (window.attachEvent ? window.attachEvent('onload', ldinsp) : window.addEventListener('load', ldinsp, false)) : ldinsp();
      })();
      </script>
      <!-- End Inspectlet Embed Code -->

    </head>
    <body>

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<div id="post-page">
  <header id="header-post">
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          
  

<nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/#about" class="smooth-scroll-to">About Us</a></li>
      <li><a href="/team">Meet the Team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="#contact" class="smooth-scroll-to">Contact</a></li>
    </ul>
  </div>
</nav>

  <h2 class="gizra-logo"><a href="/">gizra</a></h2>



        </div>
      </div>
    </div>
  </header>

  <div class="content-container">
    <article class="post">
      <h1><a href="/content/data-migration-part-1/">Data Migration - part 1 </a></h1>
      <div class="date">06 Jan 2011, By Amitai Burstein</div>
      <div class="tags">
        <img src="/images/post/tag-icon-small.15a8.png" class="tags-icon"/>
        <ul class="inline">
          
          

  
    
      <li><a href="/tags.html#Migrate-ref">Migrate</a></li>
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
  


        </ul>
        </div>
      <div class="post-content">

        <p>Moving an old site to Drupal?</p>

<p>The following article will discuss the right way to do this using the module <a href ="http://drupal.org/project/migrate"> Migrate (version2)</a>.
Migrate V2 uses <a href ="http://drupal.org/project/drush">Drush</a> (Drupal Shell)  to execute the migration functions, if your are not familiar with Drush I suggest looking into this very powerful tool.</p>

<p>Here is a list of the main challenges I have faced during the process :</p>

<ol>
    <li> Mapping old information to the new structure.</li>
    <li> Mapping the old values to match the new fields.</li>
    <li> Moving the references between the old objects into Drupal.</li>
</ol>

<!-- more -->

<p>Install the following modules :
<ol>
<li> <a href ="http://drupal.org/project/drush">drush</a></li>
<li> <a href ="http://drupal.org/project/migrate">Migration 6.x</a> </li>
<li> activate Migrate ,Migrate UI</li>
</ol></p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">drush dl migrate
drush en migrate migrate_ui
</code></pre></div>
<p>In this example we will import Users from the old site , take a look at the old Users table:</p>

<p>car_users:</p>

<p><img src="/assets/images/legacy/blog1_tab1_0.jpg" alt=""/></p>

<p>For the migrate module to recognize classes defined by your module, you must define hook<em>migrate</em>api() in your .module file:
<code>php
&lt;?php
function example_migrate_api() {
  $api = array(
    &#39;api&#39; =&gt; 2,
  );
  return $api;
}
?&gt;
</code></p>

<p>Define the migration class, each migration class should end with the suffix Migration .</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">OldUsersMigration</span> <span class="k">extends</span> <span class="nx">Migration</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">description</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="s1">&#39;Migrate users from the source database&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>define the source (the old data object) :</p>

<p>This part is used in order to map the primary key of the old USERS table. We ll also use this mapping when we want to import objects that were references to users (in our case , users).
This mean that Migrate will take care of coordinating the old UID to the new one.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MigrateSQLMap</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">machineName</span><span class="p">,</span>
    <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;user_id&#39;</span>  <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span>
        <span class="s1">&#39;not null&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
      <span class="p">),</span>
    <span class="p">),</span>
    <span class="nx">MigrateDestinationTerm</span><span class="o">::</span><span class="na">getKeySchema</span><span class="p">()</span>
  <span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Now, we want to set a query to bring our source records (from the old DB), we use the db<em>select function as described bellow:
&ldquo;`php
&lt;?php
   $query = db</em>select(&lsquo;car<em>users&rsquo;, &lsquo;old</em>users&rsquo;)
     -&gt;fields(&lsquo;old<em>users&rsquo; ,array(
      &lsquo;email&rsquo; ,
      &lsquo;user</em>id&rsquo; ,
      &lsquo;password&rsquo;,
      &lsquo;date<em>of</em>birth&rsquo; ,
      &lsquo;last<em>login</em>date&rsquo; ,
      &lsquo;username&rsquo;,
    ));
  $this-&gt;source = new MigrateSourceSQL($query);
?&gt;
&rdquo;`</p>

<p>Define the destination , for example : user , taxonomy , node.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destination</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MigrateDestinationUser</span><span class="p">();</span> <span class="c1">// Drupal user</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Its time to start the field mapping , here we will map all the fileds that we want to import from the old DB to the new field name in drupal for example :</p>

<p>password : the old site password field.
pass: the Drupal password field.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;pass&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;last_login_date&#39;</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;date_added&#39;</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;signature&#39;</span><span class="p">,</span> <span class="s1">&#39;moto&#39;</span><span class="p">);</span>
  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;access&#39;</span><span class="p">,</span> <span class="s1">&#39;last_login_date&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>In order to complete the mapping process, we need to mark all the destination fields that are NOT mapped as DNM (do not map)  :</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
    <span class="c1">//all the fields we don’t wanna map in the destination!!!</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;init&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;picture&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;timezone&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;signature_format&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;theme&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">issueGroup</span><span class="p">(</span><span class="nx">t</span><span class="p">(</span><span class="s1">&#39;DNM&#39;</span><span class="p">));</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Druring the mapping you can use the &lsquo;migrate ui&rsquo; to see your migration map status:</p>

<p>open the page /basepath/admin/content/migrate</p>

<p><img src="/assets/images/legacy/blog1_tab2_0.png" alt=""/></p>

<p>Now we can executing the migration using  Drush, the excute functions allows us a process of trial and error using the command, <i>drush migrate-import</i> and <i>drush migrate-rollback</i> repeadly.</p>

<p>To import the first 10 users :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">drush mi oldUsers –-itemlimit=10
</code></pre></div>
<p>To roll back to the previous state :</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">drush mr oldUsers –-itemlimit=10
</code></pre></div>
<p>To see your data migration status use:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">drush ms oldUsers
</code></pre></div>
<p>In the next chapter we will discuss importing cars of the users with an emphasis on the transfer relationships between tables, files, etc. ..</p>


      </div>
    </article>
    <section class="post-nav">
      <div class="row">
        <div class="col-xs-6 previous">
          
          <div class="text-capitalize">
            <a href="/content/drupalcamp-athens/">
              Previous
              <span class="visible-xs"> post</span>
            </a>
          </div>
          <a href="/content/drupalcamp-athens/" class="prev-text">
            <span class="hidden-xs">Drupalcamp Athens</span>
          </a>
          
        </div>
        <div class="col-xs-6 next">
          
          <div class="text-capitalize">
            <a href="/content/data-migration-part-2/">
              Next
              <span class="visible-xs"> post</span>
            </a>
          </div>
          <a href="/content/data-migration-part-2/" class="next-text">
            <span class="hidden-xs">Data Migration - part 2</span>
          </a>
          
        </div>
      </div>
    </section>
    <section class="author-details">
      <div class="image-wrapper">
        <img src="/images/team/avatars/amitaibu.42a1.jpg" class="img-circle img-responsive">
      </div>
      <div class="text-wrapper">
        <span class="name">Amitai Burstein</span>
        
          <span class="twitter">(@amitaibu)</span>
        
        <div class="title">CTO, Co-Owner</div>
        <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
      </div>
    </section>
    <section>
      <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </section>
  </div>
</div>


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner Street, Tel Aviv</span>
                      <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">United States Office</div>
                    <span>157 Columbus Avenue, 4th Floor, New York, NY 10023</span>
                    <a class="telephone" href="tel:+13476864508">347-686-4508</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                    <span class="link github">
                      <a href="https://github.com/Gizra" target="_blank" title="Gizra's Github Account"><i class="fa fa-github-square"></i></a>
                    </span>
                    <span class="link twitter">
                      <a href="https://twitter.com/gizra_drupal" target="_blank" title="Gizra's Twitter Account"><i class="fa fa-twitter-square"></i></a>
                    </span>
                    <span class="link linkedin">
                      <a href="https://www.linkedin.com/company/gizra-ltd" target="_blank" title="Gizra's LinkedIn Page"><i class="fa fa-linkedin-square"></i></a>
                    </span>
                    <span class="link facebook">
                      <a href="https://www.facebook.com/gizraltd/timeline" target="_blank" title="Gizra's Facebook Page"><i class="fa fa-facebook-square"></i></a>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.7686.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.ddd6.js"></script>
    </body>
</html>
