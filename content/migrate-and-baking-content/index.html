<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Migrate, and baking content</title>
        <meta name="viewport" content="width=device-width">

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.b3df.png">
      <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.a84d.png">
      <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.664d.png">
      <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.faf5.png">
      <link rel="apple-touch-icon" sizes="114x114" href=/"images/favicons/apple-touch-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.d810.png">
      <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.1807.png">
      <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.71bf.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.a9f0.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.e5f8.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.0b72.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.7353.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

        <link rel="stylesheet" href="/css/main.3fc9.css"/>

        <link href='http://fonts.googleapis.com/css?family=Abril+Fatface' rel='stylesheet' type='text/css'>

        <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


    </head>
    <body>

    

    <header class="white">
      <div class="container">
        <div class="logo"><a href="/">gizra</a></div>
        <nav id="nav" role="navigation" class="navbar navbar-default nav-fixed">
          <div class="navbar-header">
            <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li><a href="/#work">Work</a></li>
              <li><a href="/#about">About</a></li>
              <li><a href="/blog">Blog</a></li>
              <li><a href="/team">Team</a></li>
              <li><a href="/#contact">Contact</a></li>
            </ul>
          </div>
        </nav>
      </div> <!-- End of container -->
    </header>

    


    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<section id="post-page">
  <div class="background">
    <img src="/images/post/background.71f5.png">
  </div>

  <div class="ballons"></div>
  <div class="post-back">
    <a href="/blog">
      <img src="/images/post/post-back.fca6.png">
    </a>
  </div>

  <div class="content">
    <div class="container">
      <div class="row">

        <div class="col-md-8 col-md-offset-2 post">
          <div class="row">
            <div class="post-label">
              <a href="/content/migrate-and-baking-content/">Migrate, and baking content</a>
            </div>
          </div>

          <div class="row small-row">
            <div class="date">27 Dec 2012</div>
            <div class="seprator">|</div>
            <div class="author">By Amitai Burstein</div>
          </div>

          <div class="row small-row">
            <div class="tags">

              
              <ul class="inline">
                
                

  
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
      <li><a href="/tags.html#Migrate-ref">Migrate</a></li>
    
  


              </ul>
              
            </div>

            <div class="comments-count"><a href="http://www.gizra.com/content/migrate-and-baking-content/#disqus_thread"></a></div>
          </div>

          <div class="row">
            <div class="post-content">
              <p>A small problem in Drupal occurs when developing new modules, or installation profiles. Content.
It goes missing, and without it developing can go wrong very quickly. Also, starting up a site’s install profile that reveals a site without content gives a feel of walking into an empty bakery shop. There’s ovens, flour, and bakers, and that great bakery smell all around, but no bread. And possible clients go to other bakeries if you run out of bread. So to solve this issue, <a href="http://drupal.org/project/migrate">Migrate</a>  module helps us fill up the shop with bread.
Oh, and you can also migrate data from other (older) sites.</p>

<!-- more -->

<h3>What is it good for?</h3>

<p>Migrate fills up your Drupal installation profile, or just fresh new module, with appropriate content that helps the user or developer experiment with it, so the new module’s learning curve is easier. When developing, if you mess something up - say, drop the user table - it won’t be as bad as it could’ve been, since you kept around a backup in a CSV file. Some company want their site upgraded? No problem. Migrate can import from CSV, SQL databases, XML and much more.</p>

<p>_For the less technical: if you think I&#39;m just naming random letters, relax: if you have Microsoft Excel, or even OpenOffice (it&#39;s free!), you can start creating content before you even have a site. Just open up a new table in either software, and save it as a CSV file. Your developer should be able to guide you through in a few minutes. If he can’t, well, you might want to consider a different one.</p>

<p>Migrate provides a strong advantage when developing installation profiles. When you rebuild a profile, the existing database is thrown away and replaced with a new one. But most of the time, you will need content to work with, test your logic, and see the resulting displayed page. With Migrate, when you install a profile, you can automatically import content to work with.</p>

<p>Also, Migrate is great for it’s obvious main purpose - to migrate sites’ content to a drupal installation. This is great if you’re building a site for a client that already has a working site but is looking for an upgrade and is afraid of losing all of the site’s content.</p>

<p>However, the best use of Migrate is during the initial development of a new site. Think of it like that: the bakery is still being built, but the baker can&#39;t wait to start baking. He has all those little recipes he&#39;s anxious to try, so in the meantime he prepares dough and keeps it in his household refrigerator.
The same principle occurs with Migrate: while Dave, the developer, is building on the structure of the database, content types and whatnots, Sam, the site&#39;s manager, can start creating content, and customize it&#39;s structure according to his needs. All Sam needs to do is create a table and save it in some Migrate-able format (like a CSV file) . This saves time for Sam till he can launch the site, since he can start preparing the content – and put the dough straight in the oven from the refrigerator, without hassling around with flour and eggs. The site will have a quicker &#39;cool down&#39; time between the development is finished until the site is actually launched, since the content is already stored and ready to be used.</p>

<p>Not only time is saved. Dave receives less stress from Sam while developing, since Sam is busy creating content for the new site. Confusion is reduced when Sam decides some content&#39;s structure needs to be altered during development (which occurs quite often) to better suit his needs. A more finely defined content is created as a result, better suited to Sam&#39;s needs, and with less last-minute fixes. A few lines of migration code and voila! Everything is ready for the newly structured content.</p>

<h3>So, how do I use Migrate?</h3>

<p>Data storage (a.k.a - Sam’s side of the story)
The migrate module reads information stored in .csv files. An example of one of these is shown below:</p>

<p><img src="/assets/images/legacy/s025.png" /></p>

<p>Notice that ‘company’ and ‘status’ columns are filled with references to other entities’ IDs.</p>

<p>That’s it for site developers. Create a table, make sure everything sits the way you want it, and send it to the developer.</p>

<h4>The Drupal side: (a.k.a - Dave’s side of the story)</h4>

<p>If you’re reading this, I’m assuming you are a Drupal developer (it’s quite technical from now on). I’ve written a simplified example, divided into parts. In this example, I’ve shown how to migrate content from CSV files. A complete, working example of an abstract migration class can be found <a href="https://github.com/Gizra/Garment-Box/blob/7.x-1.x/garmentbox/modules/custom/garmentbox_migrate/includes/garmentbox_migrate.migrate.entity.inc">here</a> - and in the same git repository there is a complete implementation of a custom Migrate module. All the CSV files under under a csv direcrory using a naming convention <code>csv/entity_type/bundle.csv</code>. Example of using this abstract class to import taxonomy terms is shown below:
&lt; img src=&quot;http://www.gizra.com/sites/default/files/s033.png&quot; /&gt;</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * Migrate measurement unit terms.</span>
<span class="sd"> *</span>
<span class="sd"> * Use garmentboxMigration class to import taxonomy terms.</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">garmentboxMeasurementUnitTerms</span> <span class="k">extends</span> <span class="nx">garmentboxMigration</span> <span class="p">{</span>

  <span class="c1">// Define entity type and bundle, used in garmentboxMigration.</span>
  <span class="k">public</span> <span class="nv">$entityType</span> <span class="o">=</span> <span class="s1">&#39;taxonomy_term&#39;</span><span class="p">;</span>
  <span class="k">public</span> <span class="nv">$bundle</span> <span class="o">=</span> <span class="s1">&#39;measurement_units&#39;</span><span class="p">;</span>

  <span class="c1">// Map columns to import. garmentboxMigration already mapped &quot;id&quot; and</span>
  <span class="c1">// &quot;name&quot;.</span>
  <span class="k">public</span> <span class="nv">$csvColumns</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;field_unit_type&#39;</span><span class="p">,</span>
    <span class="s1">&#39;field_conversion_ratio&#39;</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">();</span>
    <span class="c1">// Map the mapped columns to fields.</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;field_unit_type&#39;</span><span class="p">,</span> <span class="s1">&#39;field_unit_type&#39;</span><span class="p">);</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;field_conversion_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;field_conversion_ratio&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>And that’s it. <code>garmentboxMigration</code> takes care of stitching everything together, and putting the data in the content’s fields. You can obviously extend this abstract class to fit your own business logic.
Importing files and images is also easy:</p>

<p><img src="/assets/images/legacy/s029.png" /></p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;field_image&#39;</span><span class="p">,</span> <span class="s1">&#39;field_image&#39;</span><span class="p">);</span>
<span class="nv">$this</span>
  <span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;field_image:file_replace&#39;</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="na">defaultValue</span><span class="p">(</span><span class="nx">FILE_EXISTS_REPLACE</span><span class="p">);</span>
<span class="nv">$this</span>
  <span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;field_image:source_dir&#39;</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="na">defaultValue</span><span class="p">(</span><span class="nx">drupal_get_path</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;example_migrate&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s1">&#39;/images&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>For multiple values in one field, use the separator(&#39;|&#39;) function when defining field mapping:
<img src="/assets/images/legacy/s028.png" /></p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nv">$this</span>
  <span class="o">-&gt;</span><span class="na">addFieldMapping</span><span class="p">(</span><span class="s1">&#39;field_inventory_line_inline&#39;</span><span class="p">,</span> <span class="s1">&#39;field_inventory_line_inline&#39;</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="na">sourceMigration</span><span class="p">(</span><span class="s1">&#39;exampleInventoryLines&#39;</span><span class="p">)</span>
  <span class="o">-&gt;</span><span class="na">separator</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>For additional data tweaking, we can use the <code>prepare()</code>, <code>prepareRow()</code>, and <code>complete()</code> functions.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">complete</span><span class="p">(</span><span class="nv">$entity</span><span class="p">,</span> <span class="nv">$row</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do something, e.g. flag a flag on the node.</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>After everything is built, we stroll over to the UI (admin/content/migrate) and select what we want to import, and import away. Alternatively, Migrate can run through drush, which you&#39;ll probably want to use when using an installation profile.</p>

            </div>
          </div>

          <div class="row">
            <div class="bottom-dash"></div>
          </div>

          <div class="row post-nav">
            <div class="first">
              
              <div class="previous">
                <a href="/content/drupal-nodejs-pantheon-and-heroku/">
                  Previous
                </a>
              </div>
              <a href="/content/drupal-nodejs-pantheon-and-heroku/" class="prev-text">
                Drupal, Node.js, Pantheon, and Heroku
              </a>
              
            </div>
            <div class="last">
              
              <div class="next">
                <a href="/content/harvard-openscholar/">
                  Next
                </a>
              </div>
              <a href="/content/harvard-openscholar/" class="next-text">
                Harvard's OpenScholar
              </a>
              
            </div>
          </div>

          <div class="row author-details">
            <div class="image-wrapper">
              <img src="/images/team/amitaibu.4179.jpg" class="img-responsive">
            </div>
            <div class="text-wrapper">
              <span class="name">Amitai Burstein</span> <span class="twitter">(@amitaibu)</span>
              <div class="title">CTO, Co-Owner</div>
              <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
            </div>
          </div>

          <div class="row">
            <div class="bottom-dash-small"></div>
          </div>

          <div class="row">
            <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

          </div>

        </div>
      </div>
    </div>
  </div>
</section>

<script type="text/javascript">
var disqus_shortname = 'gizra';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>




    <script src="/js/plugins.5250.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.d40a.js"></script>

    </body>
</html>
