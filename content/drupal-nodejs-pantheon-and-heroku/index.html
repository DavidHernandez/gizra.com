<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Drupal, Node.js, Pantheon, and Heroku</title><meta name=viewport content="width=device-width"><link rel=stylesheet href=/css/main.9961.css><link href="http://fonts.googleapis.com/css?family=Abril+Fatface" rel=stylesheet type=text/css></head><body><header class=white><div class=container><div class=logo><a href="/">gizra</a></div><nav id=nav role=navigation class="navbar navbar-default nav-fixed"><div class=navbar-header><button data-target=.navbar-collapse data-toggle=collapse class=navbar-toggle type=button><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href=/products>Products</a></li><li><a href=/#about>About</a></li><li><a href=/#work>Work</a></li><li><a href=/#code>Showcase</a></li><li><a href=/blog class=active>Blog</a></li><li><a href=/#contact>Contact</a></li></ul></div></nav></div><!-- End of container --></header><section id=post-page><div class=background><img src=/images/post/background.2707.png></div><div class=ballons></div><div class=post-back><a href=/blog><img src=/images/post/post-back.fca6.png></a></div><div class=content><div class=container><div class=row><div class="col-md-12 post"><div class=row><div class="post-label col-xs-12"><a href="/content/drupal-nodejs-pantheon-and-heroku/">Drupal, Node.js, Pantheon, and Heroku</a></div></div><div class="row small-row"><div class="date col-md-3 col-sm-3 col-xs-4">19 Dec 2012</div><div class="seprator col-md-1 col-sm-1 col-xs-1">|</div><div class="author col-md-8 col-sm-7 col-xs-6">By Amitai Burstein</div></div><div class="row small-row"><div class="tags col-sm-9"><ul class=inline><li><a href=/tags.html#Node.js-ref>Node.js</a></li><li><a href=/tags.html#Pantheoen-ref>Pantheoen</a></li><li><a href=/tags.html#tutorial-ref>tutorial</a></li><li><a href=/tags.html#Drupal-planet-ref>Drupal-planet</a></li></ul></div><div class="comments-count col-sm-3"><a href=http://www.gizra.com/content/drupal-nodejs-pantheon-and-heroku/#disqus_thread></a></div></div><div class=row><div class="col-xs-12 post-content"><p>Some title, right?</p><p><a href=http://drupal.org/project/nodejs>Node.js</a> module for Drupal is so great and a time saver, I’ve got spare time to blog about how to set it up. Future me, we’ll thank me for doing so.</p><p>First, let’s define the goals for this blog post</p><ul><li>Learn how to setup the Node.js module and server on a <em>local</em> server</li><li>Setup on a remote server using Heroku and Pantheon</li></ul><!-- more --><h3>Install node</h3><p>Node.js module&#39;s README.txt explains how to do it. I’m using Mac so for me it was a simple <code>brew install node</code>. Get the latest release of the Node.js module, and enable it. Download the node libraries needed by executing <code>npm install</code> from the Node.js module directory. That command will look at <code>package.json</code> and install all the dependencies. Ok, On to the interesting parts.</p><h3>Local Server</h3><p>Node.js module requires a simple configuration file that will tell it where the node.js server is running, and where the &quot;backend&quot; is (i.e. Drupal). Ignore the example in README.txt, eyes over here please. Assuming my Drupal site is on http://localhost/d7_dev here’s <code>nodejs.config.js</code>:</p><div class=highlight><pre><code class="javascript language-javascript" data-lang=javascript><span class=nx>settings</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>scheme</span><span class=o>:</span> <span class=s1>&#39;http&#39;</span><span class=p>,</span>
  <span class=nx>port</span><span class=o>:</span> <span class=mi>5000</span><span class=p>,</span>
  <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
  <span class=nx>resource</span><span class=o>:</span> <span class=s1>&#39;/socket.io&#39;</span><span class=p>,</span>
  <span class=nx>serviceKey</span><span class=o>:</span> <span class=s1>&#39;beejeebusRocks&#39;</span><span class=p>,</span>
  <span class=nx>backend</span><span class=o>:</span> <span class=p>{</span>
    <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span><span class=p>,</span>
    <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
    <span class=nx>scheme</span><span class=o>:</span> <span class=s1>&#39;http&#39;</span><span class=p>,</span>
    <span class=nx>basePath</span><span class=o>:</span> <span class=s1>&#39;/d7_dev&#39;</span><span class=p>,</span>
    <span class=nx>messagePath</span><span class=o>:</span> <span class=s1>&#39;/nodejs/message&#39;</span>
  <span class=p>},</span>
  <span class=nx>debug</span><span class=o>:</span> <span class=kc>true</span>
<span class=p>};</span>
</code></pre></div><p>The first part tells Node.js module where the node.js server will live. In the above example it will be <code>http://localhost:5000</code>. Same host different ports.</p><p>The &quot;backend&quot; part tells the node.js server where our Drupal site is. The <code>serviceKey</code> is the secret code used by Drupal to communicate with the node.js server. In my example it’s also used as a special thank you for <strong>beejeebus</strong>, the module maintainer. Next, from the command line execute <code>node server.js</code>. If you defined the URL and port correctly (pay extra attention to all those leading and trailing slashes!) you should see</p><div class=highlight><pre><code class="text language-text" data-lang=text>Started http server.
   info  - socket.io started
</code></pre></div><p>Visit <code>http://localhost:5000/</code> and the (confusing) message “Not found” should greet you. Wait, What? Why “Not found”, if it’s working?! The reason is that the node.js server is accepting only POST and any GET results with a 404.</p><p>Back to Drupal. In your <code>settings.php</code> add <code>$conf[&#39;nodejs_service_key&#39;] = &#39;beejeebusRocks&#39;;</code>, which is the Drupal equivalent for the serviceKey in the JS configuration. Visit <code>admin/config/nodejs/config</code> and fill out the form, this time to let _Drupal know about the node.js server. Again, pay attention to leading and trailing slashes. Node.js server host = localhost port = 5000</p><h4>The Fun Part!</h4><ol><li>Enable “Nodejs Notifications” module</li><li>Open another browser in the background, and login as another user</li><li>Back as the administrator go to ```admin/config/nodejs/nodejs_notify/broadcast``` and broadcast your message</li><li>The message will appear using Growl in the second browser</li><li>Repeat 2 - 5 until you climax. Personally, It took me about 10 browsers open simultaneously to get there!</li></ol><h3>Deploy it!</h3><p>Ok, we had our fun on the local server time to see it in action, on a _real server. This time let&#39;s start with the Drupal part. Probably the quickest way to get it up is to grab an account on <a href="https://www.getpantheon.com/">Pantheon</a> and create a Clean Drupal 7 installation (I did it two years ago, and haven&#39;t regretted since...) Let&#39;s say my new site is called <code>dev.gizra.gotpantheon.com</code> Add the module, and the service key in settings.php, yada yada yada. Indeed, we will still need to deal with the Node.js module configuration. Right after the Heroku section.</p><h4>The Heroku section</h4><p>Wow. Seriously. Those guys in Heroku made deployment of a node.js server really easy. After you sign up, and download the <a href=https://toolbelt.heroku.com>Heroku toolbelt</a> (a command line utility), you can read <a href=https://devcenter.heroku.com/articles/nodejs>this</a> quick introduction that will show you how easy it&#39;s to deploy from the command line. If you know how to use git, you&#39;ll know to use Heroku.</p><p>Git clone <a href=https://github.com/amitaibu/DrupalNodejsHeroku>amitaibu/DrupalNodejsHeroku</a> outside of the Drupal installation. Quick file overview: I&#39;ve Copied <code>server.js</code> from the Node.js module. I&#39;ve changed a bit the <code>package.json</code> so Heroku will be able to build it. I&#39;ve added a default <code>nodejs.config.js</code> you <strong>will need to edit</strong> and add your own <code>serviceKey</code> and <code>backend.host</code>. Here is how my file looked</p><div class=highlight><pre><code class="javascript language-javascript" data-lang=javascript><span class=nx>settings</span> <span class=o>=</span> <span class=p>{</span>
  <span class=nx>scheme</span><span class=o>:</span> <span class=s1>&#39;http&#39;</span><span class=p>,</span>
  <span class=nx>port</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>||</span> <span class=mi>5000</span><span class=p>,</span>
  <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
  <span class=nx>resource</span><span class=o>:</span> <span class=s1>&#39;/socket.io&#39;</span><span class=p>,</span>
  <span class=nx>serviceKey</span><span class=o>:</span> <span class=s1>&#39;beejeebusRocks&#39;</span><span class=p>,</span>
  <span class=nx>backend</span><span class=o>:</span> <span class=p>{</span>
    <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;dev.gizra.gotpantheon.com&#39;</span><span class=p>,</span>
    <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span><span class=p>,</span>
    <span class=nx>scheme</span><span class=o>:</span> <span class=s1>&#39;http&#39;</span><span class=p>,</span>
    <span class=nx>messagePath</span><span class=o>:</span> <span class=s1>&#39;/nodejs/message&#39;</span>
  <span class=p>},</span>
  <span class=nx>transports</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;xhr-polling&#39;</span><span class=p>],</span>
  <span class=nx>debug</span><span class=o>:</span> <span class=kc>true</span>
<span class=p>};</span>
</code></pre></div><p>Notice several changes:<ul><li>backend.host is now pointing to my own Pantheon site. Remember to change it</li><li>The port of the node.js server is now <code>process.env.PORT || 5000</code>. Heroku will make sure to inject that variable when executed, so our node.js server will listen on the right port</li><li>The transport mechanism is xhr-polling. Heroku still doesn&#39;t sup Websockets port, but bare in mind that it&#39;s the node.js server that gets the polling, _not the Drupal server</li></ul></p><p>Next, we can deploy it to Heroku.</p><div class=highlight><pre><code class="bash language-bash" data-lang=bash><span class=nv>$ </span>heroku create
<span class=nv>$ </span>git push heroku master
</code></pre></div><p>(I also added a .gitignore file that will ignore <code>node_modules</code> in case you will <code>npm install</code>). Notice how not only the files are pushed to git, but Heroku now builds the dependencies and launches the server. In the end of the output you will see the URL of your new site. That&#39;s the node.js server URL, Drupal will POST data to. You can also open it with <code>heroku open</code></p><h4>Back to Drupal</h4><p>Visit <code>admin/config/nodejs/config</code> and fill out the form. <em>My</em> configuration looked like this: Node.js server host = nameless-brook-555.herokuapp.com port = 80</p><p>Enable the Node.js modules, and start enjoying the work of other great people!</p></div></div><div class=row><div class="col-xs-12 bottom-dash"></div></div><div class="row post-nav"><div class=col-xs-6><div class=previous><a href="/content/message-subscribe-new-subscription-system/">Previous</a></div><a href="/content/message-subscribe-new-subscription-system/" class=prev-text>Message-subscribe - A New Subscription System</a></div><div class=col-xs-6><div class=next><a href="/content/migrate-and-baking-content/">Next</a></div><a href="/content/migrate-and-baking-content/" class=next-text>Migrate, and baking content</a></div></div><div class="row author-details"><div class="col-md-1 image-wrapper"><img src=/images/team/amitaibu.4179.jpg class=img-responsive></div><div class="col-md-11 text-wrapper"><span class=name>Amitai Burstein</span> <span class=twitter>(@amitaibu)</span><div class=title>CTO, Co-Owner</div><div class=bio>Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. Also likes climbing boulders.</div></div></div><div class=row><div class="col-xs-12 bottom-dash-small"></div></div></div></div></div></div></section><div id=disqus_thread></div><script type=text/javascript>var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><script type=text/javascript>var disqus_shortname = 'gizra';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());</script><script src=/js/plugins.5250.js></script><script src=/js/scripts.fb35.js></script><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');  // Replace with your property ID.
  ga('send', 'pageview');</script><!-- End Google Analytics --></body></html>