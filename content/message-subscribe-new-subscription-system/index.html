<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Message-subscribe - A New Subscription System</title><meta name=viewport content="width=device-width"><link rel=stylesheet href=/css/main.2676.css><link href="http://fonts.googleapis.com/css?family=Abril+Fatface" rel=stylesheet type=text/css></head><body><header class=white><div class=container><div class=logo><a href="/">gizra</a></div><nav id=nav role=navigation class="navbar navbar-default nav-fixed"><div class=navbar-header><button data-target=.navbar-collapse data-toggle=collapse class=navbar-toggle type=button><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href=/products>Products</a></li><li><a href=/#about>About</a></li><li><a href=/#work>Work</a></li><li><a href=/#code>Showcase</a></li><li><a href=/blog class=active>Blog</a></li><li><a href=/#contact>Contact</a></li></ul></div></nav></div><!-- End of container --></header><section id=post-page><div class=background><img src=/images/post/background.2707.png></div><div class=ballons></div><div class=post-back><a href=/blog><img src=/images/post/post-back.fca6.png></a></div><div class=content><div class=container><div class=row><div class="col-md-12 post"><div class=row><div class="post-label col-xs-12"><a href="/content/message-subscribe-new-subscription-system/">Message-subscribe - A New Subscription System</a></div></div><div class="row small-row"><div class="date col-md-3 col-sm-3 col-xs-4">31 Oct 2012</div><div class="seprator col-md-1 col-sm-1 col-xs-1">|</div><div class="author col-md-8 col-sm-7 col-xs-6">By Amitai Burstein</div></div><div class="row small-row"><div class="tags col-sm-9"><ul class=inline><li><a href=/tags.html#Drupal-planet-ref>Drupal-planet</a></li><li><a href=/tags.html#Message-ref>Message</a></li></ul></div><div class="comments-count col-sm-3"><a href=http://www.gizra.com/content/message-subscribe-new-subscription-system/#disqus_thread></a></div></div><div class=row><div class="col-xs-12 post-content"><blockquote><p>Drupal 6 had Messaging &amp; Notification Drupal 7 has Message-subscribe &amp; Message-notify</p></blockquote><p><a href=http://drupal.org/project/message_subscribe>Message-subscribe</a> is a new module in the Message stack, that finally ties everything together to give us the ability to subscribe to content, and send notifications.</p><p>If you know Message you already know that some development skills, or knowing Rules really really good are needed. This post will go over the main concepts and flow of the notification process.</p><p>Message-subscribe, just like Message module has zero knowledge about your business logic - it is up to you to implement the Message creation. What Message subscribe gives you, though, is one simple function your implementing module will call -- and that’s it. It will take care of it from there.</p><!-- more --><p>For example imagine an existing node, that people in the site want to subscribe to, and get notified about new comments.</p><h3>Subscribing to content</h3><p>Subscribing is naturally done using Flag module. There’s no assumption related to the amount of Flags you have - as long as you prefix your flag name with <code>subscribe_</code> Message-subscribe treats it as a valid flag.</p><h3>Message creation</h3><div class=highlight><pre><code class="php language-php" data-lang=php><span class=cp>&lt;?php</span>

<span class=sd>/**</span>
<span class=sd> * Implements hook_comment_insert().</span>
<span class=sd> *</span>
<span class=sd> * Send a message when a new comment is created to subscribed users.</span>
<span class=sd> */</span>
<span class=k>function</span> <span class=nf>foo_example_comment_insert</span><span class=p>(</span><span class=nv>$comment</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Create a new message, assigned to the node author, and add a</span>
  <span class=c1>// reference to the comment, so we can later use tokens related to that</span>
  <span class=c1>// comment.</span>
  <span class=nv>$message</span> <span class=o>=</span> <span class=nx>message_create</span><span class=p>(</span><span class=s1>&#39;comment_insert&#39;</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>&#39;uid&#39;</span> <span class=o>=&gt;</span> <span class=nv>$comment</span><span class=o>-&gt;</span><span class=na>uid</span><span class=p>));</span>
  <span class=nv>$wrapper</span> <span class=o>=</span> <span class=nx>entity_metadata_wrapper</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=nv>$message</span><span class=p>);</span>
  <span class=c1>// There will be probably a reference field to the comment on the message itself.</span>
  <span class=nv>$wrapper</span><span class=o>-&gt;</span><span class=na>field_comment_ref</span><span class=o>-&gt;</span><span class=na>set</span><span class=p>(</span><span class=nv>$comment</span><span class=p>);</span>

  <span class=c1>// Let Message-subscribe save and send notifications.</span>
  <span class=nx>message_subscribe_send_message</span><span class=p>(</span><span class=s1>&#39;comment&#39;</span><span class=p>,</span> <span class=nv>$comment</span><span class=p>,</span> <span class=nv>$message</span><span class=p>);</span>
<span class=p>}</span>

<span class=cp>?&gt;</span><span class=x></span>
</code></pre></div><p>As seen in the above code, our module created the Message it wanted and passed it along to <code>message_subscribe_send_message()</code>. Let’s see what happens from there.</p><h3>Getting “context”</h3><p>Drupal abuses the word context with so many meanings. Admittedly Message-subscribe is now also guilty. <code>message_subscribe_get_basic_context()</code> gets the entity type, in our case the comment, and extracts the related context -- the comment author, the node its related to, the taxonomy terms related to the node, the OG groups related to those nodes (you can add our own context as-well). This context will help us in finding all the users that are subscribed directly or _indirectly to our node.</p><h3>Getting the subscribers</h3><p>Next, Message-subscribe queries the valid flags, iterating over the results to get all the users that are subscribed. An alter hook allows you to change the list, or the values in that list. The values are which flags are responsible for the subscription and the “Message notifiers” (about that in the next section).</p><h3>Sending notifications</h3><p>Before we talk about sending notifications, note that I never wrote the word “email”. Message-notify is a pluggable module, that allows you to add “Message-notifiers”. There’s a default implementation for email, but you are also able to add Text-messages, IRC, Fax or Postal-pigeons.</p><p>So, Message-subscribe iterates over all the users, and all over the notifiers, as in fact a user can get the same Message as email _and as a Text-message. I say same _Message as in same Message entity, not same message as message text -- In Message-notify you can have different text for different notifiers thanks to the module’s integration with view-modes.</p><h3>Bonus</h3><ul><li>There’s a UI! We are showing tabs for every valid flag, and the content of that tab is a View. You can easily change the used View via admin settings <img src=http://drupal.org/files/project-images/message-subscribe.jpg width=640 height=214></li><li>It’s a Message entity, right? So it means that the email you’ve just sent, can be saved and be used for an activity stream. 2 for the price of 1</li><li>For a scalable solution, we are currently working - with a great help from fubhy - on implementing some sort of DrupalQueue to be able to process lots of Messages</li></ul></div></div><div class=row><div class="col-xs-12 bottom-dash"></div></div><div class="row post-nav"><div class=col-xs-6><div class=previous><a href="/content/drupalcamp-montreal-keynote/">Previous</a></div><a href="/content/drupalcamp-montreal-keynote/" class=prev-text>DrupalCamp Montreal Keynote</a></div><div class=col-xs-6><div class=next><a href="/content/drupal-nodejs-pantheon-and-heroku/">Next</a></div><a href="/content/drupal-nodejs-pantheon-and-heroku/" class=next-text>Drupal, Node.js, Pantheon, and Heroku</a></div></div><div class="row author-details"><div class="col-md-1 image-wrapper"><img src=/images/team/amitaibu.4179.jpg class=img-responsive></div><div class="col-md-11 text-wrapper"><span class=name>Amitai Burstein</span> <span class=twitter>(@amitaibu)</span><div class=title>CTO, Co-Owner</div><div class=bio>Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div></div></div><div class=row><div class="col-xs-12 bottom-dash-small"></div></div><div class=row><div id=disqus_thread></div><script type=text/javascript>var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div></div></div></section><script type=text/javascript>var disqus_shortname = 'gizra';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());</script><script src=/js/plugins.5250.js></script><script src=/js/scripts.ccb8.js></script><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');  // Replace with your property ID.
  ga('send', 'pageview');</script><!-- End Google Analytics --></body></html>