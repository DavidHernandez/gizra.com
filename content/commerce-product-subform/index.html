<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        
    

<title>Commerce product + Subform</title>

        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.3a41.png">
      <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.a84d.png">
      <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.664d.png">
      <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.20fe.png">
      <link rel="apple-touch-icon" sizes="114x114" href=/"images/favicons/apple-touch-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.842b.png">
      <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.0175.png">
      <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.f9ac.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.f24a.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.2d07.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.6d91.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.a93c.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.7ce6.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->

              
    </head>
    <body>
    <!-- ClickTale Top part -->
    <script type="text/javascript">
    var WRInitTime=(new Date()).getTime();
    </script>
    <!-- ClickTale end of Top part -->

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<div id="post-page">
  <header id="header-post">
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          
  

<nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/#about" class="smooth-scroll-to">About us</a></li>
      <li><a href="/team">Meet the team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="#contact" class="smooth-scroll-to">Contact</a></li>
    </ul>
  </div>
</nav>

  <h2 class="gizra-logo"><a href="/">gizra</a></h2>



        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-sm-10 col-sm-offset-1">
        <article class="post">
          <h1><a href="/content/commerce-product-subform/">Commerce product + Subform </a></h1>
          <div class="date">29 Jan 2012, By Amitai Burstein</div>
          <div class="tags">
            <img src="/images/post/tag-icon-small.15a8.png" class="tags-icon"/>
            <ul class="inline">
              
              

  
    
      <li><a href="/tags.html#Commerce-ref">Commerce</a></li>
    
      <li><a href="/tags.html#Subform-ref">Subform</a></li>
    
      <li><a href="/tags.html#CTools-ref">CTools</a></li>
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
  


            </ul>
            </div>
          <div class="post-content">

            <p><strong>Edit: Use the <a href="http://drupal.org/project/inline_entity_form">Inline entity form</a> module that was created after this post was published.</strong></p>

<p>This post will go over an example (yet fully functionally) module that shows how we can embed a commerce product form inside a node form, and have the node reference the commerce product - without horrible hacks.</p>

<!-- more -->

<p><img src="/assets/images/legacy/Product-1.jpg" /></p>

<p><img src="/assets/images/legacy/Create-Product-2.jpg" /></p>

<p><img src="/assets/images/legacy/Product-3-Site-Install.jpg" /></p>

<p><a href="https://github.com/amitaibu/commerce_product_subform">Here is the code</a></p>

<p>The problem is obviously the fact that we don’t have commerce product ID nor a node ID, as none of those objects is saved. A second problem is how to actually embed the commerce product form inside the node form. <a href="http://drupal.org/project/subform">Subform</a> module solves both issues (with a little custom code help).</p>

<p>I won’t go over each line of code here, as the module is well documented, however I will explain the _important steps.</p>

<p>In the node&#39;s form alter, we embed the commerce product, using Subform’s form element.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">module_load_include</span><span class="p">(</span><span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="s1">&#39;commerce_product&#39;</span><span class="p">,</span> <span class="s1">&#39;includes/commerce_product.forms&#39;</span><span class="p">);</span>
<span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;commerce_product_subform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
  <span class="s1">&#39;#type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;subform&#39;</span><span class="p">,</span>
  <span class="s1">&#39;#subform_id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;commerce_product_ui_product_form&#39;</span><span class="p">,</span>
  <span class="s1">&#39;#subform_arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="nv">$commerce_product</span><span class="p">),</span>
  <span class="s1">&#39;#required&#39;</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">,</span>
  <span class="s1">&#39;#weight&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>In the code above we embed the form, pass it a $product object, and say it is required - meaning Subform should do validation on the embedded form.
Next step, is adding submit handlers <strong>in the right order</strong></p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1">// Set the first submit handler to be &quot;subform_submit_all&quot;, so the</span>
<span class="c1">// commerce product will be created, before handing the submitted node</span>
<span class="c1">// se we can associate the node to the commerce product.</span>
<span class="c1">// The last submit handler is the original &#39;node_form_submit&#39;, which</span>
<span class="c1">// will get all the values already populated, and save the node.</span>
<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$node</span><span class="o">-&gt;</span><span class="na">nid</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">][</span><span class="s1">&#39;submit&#39;</span><span class="p">][</span><span class="s1">&#39;#submit&#39;</span><span class="p">],</span> <span class="s1">&#39;subform_submit_all&#39;</span><span class="p">,</span> <span class="s1">&#39;commerce_product_subform_commerce_product_submit&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="c1">// The node already exists, so we assume there is already a reference</span>
  <span class="c1">// to the commerce product, so just add &quot;subform_submit_all&quot; submit</span>
  <span class="c1">// handler, to make sure the commerce product can be edited.</span>
  <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$form</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">][</span><span class="s1">&#39;submit&#39;</span><span class="p">][</span><span class="s1">&#39;#submit&#39;</span><span class="p">],</span> <span class="s1">&#39;subform_submit_all&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Noticed the emphasize on the “right order” above? That’s because we want Subform to first submit the commerce product form (thus the commerce product will be saved and have an ID), next we want our own submit handler to set the field reference from the node to the commerce product, and last we want the original <code>node_form_submit()</code> to save the node.</p>

<p>In the example module, you will notice that we also hide the commerce product title. The reason is that we can easily populate the title from the node&#39;s title (see <code>commerce_product_subform_form_commerce_product_ui_validate()</code>).</p>

<p>As bonus, the example module also has a CTools plugin, that allows you to add the subform to an node add/ edit page that was overriden by Page manager.</p>


          </div>
        </article>
        <section class="post-nav">
          <div class="row">
            <div class="col-xs-6 previous">
              
              <div class="text-capitalize">
                <a href="/content/sending-lots-emails-hint-drush/">
                  Previous
                  <span class="visible-xs"> post</span>
                </a>
              </div>
              <a href="/content/sending-lots-emails-hint-drush/" class="prev-text">
                <span class="hidden-xs">Sending LOTS of emails (Hint: with Drush)</span>
              </a>
              
            </div>
            <div class="col-xs-6 next">
              
              <div class="text-capitalize">
                <a href="/content/banner-rotator/">
                  Next
                  <span class="visible-xs"> post</span>
                </a>
              </div>
              <a href="/content/banner-rotator/" class="next-text">
                <span class="hidden-xs">Banner rotator</span>
              </a>
              
            </div>
          </div>
        </section>
        <section class="author-details">
          <div class="image-wrapper">
            <img src="/images/team/avatars/amitaibu.4179.jpg" class="img-circle img-responsive">
          </div>
          <div class="text-wrapper">
            <span class="name">Amitai Burstein</span>
            
              <span class="twitter">(@amitaibu)</span>
            
            <div class="title">CTO, Co-Owner</div>
            <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
          </div>
        </section>
        <section>
          <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </section>
      </div>
    </div>
  </div>
</div>


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner St., Tel Aviv</span>
                      <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">United States Office</div>
                    <span>1157 Columbus Ave, 4th floor. New York, NY 10023</span>
                      <a class="telephone" href="tel:+13476864508">+1 347 686-4508</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                    <span class="link github">
                      <a href="https://github.com/Gizra" target="_blank"><i class="fa fa-github-square"></i></a>
                    </span>
                    <span class="link twitter">
                      <a href="https://twitter.com/gizra_drupal" target="_blank"><i class="fa fa-twitter-square"></i></a>
                    </span>
                    <span class="link linkedin">
                      <a href="https://www.linkedin.com/company/gizra-ltd" target="_blank"><i class="fa fa-linkedin-square"></i></a>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.f180.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.ddd6.js"></script>
      
    <!-- ClickTale Bottom part -->
    
    <script type='text/javascript'>
    // The ClickTale Balkan Tracking Code may be programmatically customized using hooks:
    // 
    //   function ClickTalePreRecordingHook() { /* place your customized code here */  }
    //
    // For details about ClickTale hooks, please consult the wiki page http://wiki.clicktale.com/Article/Customizing_code_version_2
    
    document.write(unescape("%3Cscript%20src='"+
    (document.location.protocol=='https:'?
    "https://cdnssl.clicktale.net/www07/ptc/dea77991-0e38-46cc-a46f-1043e9e6e781.js":
    "http://cdn.clicktale.net/www07/ptc/dea77991-0e38-46cc-a46f-1043e9e6e781.js")+"'%20type='text/javascript'%3E%3C/script%3E"));
    </script>
    
    <!-- ClickTale end of Bottom part -->
    </body>
</html>
