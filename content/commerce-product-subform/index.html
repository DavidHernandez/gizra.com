<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Commerce product + Subform</title><meta name=viewport content="width=device-width"><link rel=stylesheet href=/css/main.9961.css><link href="http://fonts.googleapis.com/css?family=Abril+Fatface" rel=stylesheet type=text/css></head><body><header class=white><div class=container><div class=logo><a href="/">gizra</a></div><nav id=nav role=navigation class="navbar navbar-default nav-fixed"><div class=navbar-header><button data-target=.navbar-collapse data-toggle=collapse class=navbar-toggle type=button><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li><a href=/products>Products</a></li><li><a href=/#about>About</a></li><li><a href=/#work>Work</a></li><li><a href=/#code>Showcase</a></li><li><a href=/blog class=active>Blog</a></li><li><a href=/#contact>Contact</a></li></ul></div></nav></div><!-- End of container --></header><section id=post-page><div class=background><img src=/images/post/background.2707.png></div><div class=ballons></div><div class=post-back><a href=/blog><img src=/images/post/post-back.fca6.png></a></div><div class=content><div class=container><div class=row><div class="col-md-12 post"><div class=row><div class="post-label col-xs-12"><a href="/content/commerce-product-subform/">Commerce product + Subform</a></div></div><div class="row small-row"><div class="date col-md-3 col-sm-3 col-xs-4">29 Jan 2012</div><div class="seprator col-md-1 col-sm-1 col-xs-1">|</div><div class="author col-md-8 col-sm-7 col-xs-6">By Amitai Burstein</div></div><div class="row small-row"><div class="tags col-sm-9"><ul class=inline><li><a href=/tags.html#Commerce-ref>Commerce</a></li><li><a href=/tags.html#Subform-ref>Subform</a></li><li><a href=/tags.html#CTools-ref>CTools</a></li><li><a href=/tags.html#Drupal-planet-ref>Drupal-planet</a></li></ul></div><div class="comments-count col-sm-3"><a href=http://www.gizra.com/content/commerce-product-subform/#disqus_thread></a></div></div><div class=row><div class="col-xs-12 post-content"><p><strong>Edit: Use the <a href=http://drupal.org/project/inline_entity_form>Inline entity form</a> module that was created after this post was published.</strong></p><p>This post will go over an example (yet fully functionally) module that shows how we can embed a commerce product form inside a node form, and have the node reference the commerce product - without horrible hacks.</p><!-- more --><p><img src=/assets/images/legacy/Product-1.jpg></p><p><img src=/assets/images/legacy/Create-Product-2.jpg></p><p><img src=/assets/images/legacy/Product-3-Site-Install.jpg></p><p><a href=https://github.com/amitaibu/commerce_product_subform>Here is the code</a></p><p>The problem is obviously the fact that we don’t have commerce product ID nor a node ID, as none of those objects is saved. A second problem is how to actually embed the commerce product form inside the node form. <a href=http://drupal.org/project/subform>Subform</a> module solves both issues (with a little custom code help).</p><p>I won’t go over each line of code here, as the module is well documented, however I will explain the _important steps.</p><p>In the node&#39;s form alter, we embed the commerce product, using Subform’s form element.</p><div class=highlight><pre><code class="php language-php" data-lang=php><span class=cp>&lt;?php</span>
<span class=nx>module_load_include</span><span class=p>(</span><span class=s1>&#39;inc&#39;</span><span class=p>,</span> <span class=s1>&#39;commerce_product&#39;</span><span class=p>,</span> <span class=s1>&#39;includes/commerce_product.forms&#39;</span><span class=p>);</span>
<span class=nv>$form</span><span class=p>[</span><span class=s1>&#39;commerce_product_subform&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=k>array</span><span class=p>(</span>
  <span class=s1>&#39;#type&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;subform&#39;</span><span class=p>,</span>
  <span class=s1>&#39;#subform_id&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;commerce_product_ui_product_form&#39;</span><span class=p>,</span>
  <span class=s1>&#39;#subform_arguments&#39;</span> <span class=o>=&gt;</span> <span class=k>array</span><span class=p>(</span><span class=nv>$commerce_product</span><span class=p>),</span>
  <span class=s1>&#39;#required&#39;</span> <span class=o>=&gt;</span> <span class=k>TRUE</span><span class=p>,</span>
  <span class=s1>&#39;#weight&#39;</span> <span class=o>=&gt;</span> <span class=mi>10</span><span class=p>,</span>
<span class=p>);</span>
<span class=cp>?&gt;</span><span class=x></span>
</code></pre></div><p>In the code above we embed the form, pass it a $product object, and say it is required - meaning Subform should do validation on the embedded form. Next step, is adding submit handlers <strong>in the right order</strong></p><div class=highlight><pre><code class="php language-php" data-lang=php><span class=cp>&lt;?php</span>
<span class=c1>// Set the first submit handler to be &quot;subform_submit_all&quot;, so the</span>
<span class=c1>// commerce product will be created, before handing the submitted node</span>
<span class=c1>// se we can associate the node to the commerce product.</span>
<span class=c1>// The last submit handler is the original &#39;node_form_submit&#39;, which</span>
<span class=c1>// will get all the values already populated, and save the node.</span>
<span class=k>if</span> <span class=p>(</span><span class=k>empty</span><span class=p>(</span><span class=nv>$node</span><span class=o>-&gt;</span><span class=na>nid</span><span class=p>))</span> <span class=p>{</span>
  <span class=nb>array_unshift</span><span class=p>(</span><span class=nv>$form</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=s1>&#39;submit&#39;</span><span class=p>][</span><span class=s1>&#39;#submit&#39;</span><span class=p>],</span> <span class=s1>&#39;subform_submit_all&#39;</span><span class=p>,</span> <span class=s1>&#39;commerce_product_subform_commerce_product_submit&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=k>else</span> <span class=p>{</span>
  <span class=c1>// The node already exists, so we assume there is already a reference</span>
  <span class=c1>// to the commerce product, so just add &quot;subform_submit_all&quot; submit</span>
  <span class=c1>// handler, to make sure the commerce product can be edited.</span>
  <span class=nb>array_unshift</span><span class=p>(</span><span class=nv>$form</span><span class=p>[</span><span class=s1>&#39;actions&#39;</span><span class=p>][</span><span class=s1>&#39;submit&#39;</span><span class=p>][</span><span class=s1>&#39;#submit&#39;</span><span class=p>],</span> <span class=s1>&#39;subform_submit_all&#39;</span><span class=p>);</span>
<span class=p>}</span>
<span class=cp>?&gt;</span><span class=x></span>
</code></pre></div><p>Noticed the emphasize on the “right order” above? That’s because we want Subform to first submit the commerce product form (thus the commerce product will be saved and have an ID), next we want our own submit handler to set the field reference from the node to the commerce product, and last we want the original <code>node_form_submit()</code> to save the node.</p><p>In the example module, you will notice that we also hide the commerce product title. The reason is that we can easily populate the title from the node&#39;s title (see <code>commerce_product_subform_form_commerce_product_ui_validate()</code>).</p><p>As bonus, the example module also has a CTools plugin, that allows you to add the subform to an node add/ edit page that was overriden by Page manager.</p></div></div><div class=row><div class="col-xs-12 bottom-dash"></div></div><div class="row post-nav"><div class=col-xs-6><div class=previous><a href="/content/sending-lots-emails-hint-drush/">Previous</a></div><a href="/content/sending-lots-emails-hint-drush/" class=prev-text>Sending LOTS of emails (Hint: with Drush)</a></div><div class=col-xs-6><div class=next><a href="/content/banner-rotator/">Next</a></div><a href="/content/banner-rotator/" class=next-text>Banner rotator</a></div></div><div class="row author-details"><div class="col-md-1 image-wrapper"><img src=/images/team/amitaibu.4179.jpg class=img-responsive></div><div class="col-md-11 text-wrapper"><span class=name>Amitai Burstein</span> <span class=twitter>(@amitaibu)</span><div class=title>CTO, Co-Owner</div><div class=bio>Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. Also likes climbing boulders.</div></div></div><div class=row><div class="col-xs-12 bottom-dash-small"></div></div></div></div></div></div></section><div id=disqus_thread></div><script type=text/javascript>var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><script type=text/javascript>var disqus_shortname = 'gizra';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());</script><script src=/js/plugins.5250.js></script><script src=/js/scripts.fb35.js></script><!-- Google Analytics --><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');  // Replace with your property ID.
  ga('send', 'pageview');</script><!-- End Google Analytics --></body></html>