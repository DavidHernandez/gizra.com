<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Sending LOTS of emails (Hint: with Drush)</title>
        <meta name="description" content="">
        <meta name="keywords" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <!-- Favicon for all platforms -->
      <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.3a41.png">
      <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.a84d.png">
      <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.664d.png">
      <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.20fe.png">
      <link rel="apple-touch-icon" sizes="114x114" href=/"images/favicons/apple-touch-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.842b.png">
      <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.0175.png">
      <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.f9ac.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.f24a.png">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.c391.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.2d07.png" sizes="194x194">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.8557.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.6d91.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.a93c.png" sizes="16x16">
      <link rel="manifest" href="/images/favicons/manifest.json">
      <meta name="msapplication-TileColor" content="#000000">
      <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
      <meta name="theme-color" content="#ffffff">
      <!-- End favicon for all platforms -->

      <link rel="stylesheet" href="/css/main.3465.css"/>
      <link href='http://fonts.googleapis.com/css?family=Abril+Fatface' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Hind:400,600,300,500' rel='stylesheet' type='text/css'>
      <link href='https://fonts.googleapis.com/css?family=Raleway:400,300,600,800' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
      <!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-6558346-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


    </head>
    <body>

    <!-- Main content -->
    
  



  
    
      
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  


<div id="post-page">
  <header class="header-post">
    <div class="container">
      <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
          <nav id="nav" role="navigation" class="navbar navbar-default">
  <div class="navbar-header">
    <button data-target=".navbar-collapse" data-toggle="collapse" class="navbar-toggle" type="button">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
  </div>
  <div class="navbar-collapse collapse">
    <ul class="nav navbar-nav">
      <li><a href="/team">Meet the team</a></li>
      <li><a href="/blog">Blog</a></li>
      <li><a href="#contact">Contact</a></li>
    </ul>
  </div>
</nav>
<h1 class="gizra-logo"><a href="/">gizra</a></h1>

        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="row">
      <div class="col-sm-10 col-sm-offset-1">
        <article class="post">
          <h1><a href="/content/sending-lots-emails-hint-drush/">Sending LOTS of emails (Hint: with Drush) </a></h1>
          <div class="date">24 Jan 2012, By Amitai Burstein</div>
          <div class="tags">
            <img src="/images/post/tag-icon-small.15a8.png" class="tags-icon"/>
            <ul class="inline">
              
              

  
    
      <li><a href="/tags.html#Drupal-planet-ref">Drupal-planet</a></li>
    
      <li><a href="/tags.html#Message-ref">Message</a></li>
    
      <li><a href="/tags.html#Drush-ref">Drush</a></li>
    
  


            </ul>
            </div>
          <div class="post-content">

            <p>On my <a href="http://www.gizra.com/content/message-notify-multilingual-email-notifications">last blog</a> post I talked about Message notify module, and mentioned we were using it to send digest emails. While Message notify really eases the pain of creating personalized emails, and sending them, we still needed to find a scalable solutions for sending lots of emails. LOTS of emails!</p>

<p>Doing it on hook_cron() is nice if you need to send few emails, but when you need to send thousands of emails a day, it won’t do. Cron will take too long, or might hang up if we try to process too many digest emails at once.</p>

<p>A nice and simple solution we came up with, was to write a Drush command that will process a small batch of users, and use Jenkins to fire up this command every two minutes.</p>

<p>This post will demonstrate the code, that can be used by others - however you will need to copy and change the command to fit your business logic.</p>

<!-- more -->

<p>Assuming our module’s name is foo, you will need to place your code in <code>foo.drush.inc</code>:</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>

<span class="sd">/**</span>
<span class="sd"> * @file</span>
<span class="sd"> * Drush integration of Foo module.</span>
<span class="sd"> *</span>
<span class="sd"> */</span>

<span class="sd">/**</span>
<span class="sd"> * Implements hook_drush_help().</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">foo_drush_help</span><span class="p">(</span><span class="nv">$section</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nv">$section</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">&#39;drush:foo-digest&#39;</span><span class="o">:</span>
      <span class="k">return</span> <span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Send digest emails.&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * Implements hook_drush_command().</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">foo_drush_command</span><span class="p">()</span> <span class="p">{</span>
  <span class="nv">$items</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

  <span class="nv">$items</span><span class="p">[</span><span class="s1">&#39;foo-digest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;callback&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;drush_foo_digest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;drupal dependencies&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">),</span>
    <span class="s1">&#39;description&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Send digest emails.&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arguments&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;range&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;The number of users to be processed.&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s1">&#39;bootstrap&#39;</span> <span class="o">=&gt;</span> <span class="nx">DRUSH_BOOTSTRAP_DRUPAL_FULL</span><span class="p">,</span>
    <span class="s1">&#39;aliases&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;fdg&#39;</span><span class="p">),</span>
    <span class="s1">&#39;examples&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;drush foo-digest&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Process 10 users.&#39;</span><span class="p">,</span>
      <span class="s1">&#39;drush foo-digest --range=50&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Process 50 users.&#39;</span><span class="p">,</span>
    <span class="p">),</span>
  <span class="p">);</span>

  <span class="k">return</span> <span class="nv">$items</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/**</span>
<span class="sd"> * Callback function for sending digest email command.</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">drush_foo_digest</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lock_acquire</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="mf">240.0</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// Digest is already processed.</span>
    <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Attempting to re-run foo digest command while it is already running.&#39;</span><span class="p">),</span> <span class="s1">&#39;notice&#39;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$range</span> <span class="o">=</span> <span class="nx">drush_get_option</span><span class="p">(</span><span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="c1">// This function should be replaced by your function that gets all the</span>
  <span class="c1">// users that need to get the digest email.</span>
  <span class="nv">$uids</span> <span class="o">=</span> <span class="nx">foo_get_digest_users</span><span class="p">(</span><span class="nv">$range</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$uids</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;No users found for digest.&#39;</span><span class="p">),</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// This function should be replaced by your function that will send the</span>
  <span class="c1">// emails (maybe by using Message notify), and is expected to return</span>
  <span class="c1">// the user IDs of the successful emails.</span>
  <span class="nv">$return</span> <span class="o">=</span> <span class="nx">foo_process_digest</span><span class="p">(</span><span class="nv">$uids</span><span class="p">);</span>
  <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;@uids&#39;</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$return</span><span class="p">)</span> <span class="o">?</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="nv">$return</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
  <span class="p">);</span>

  <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Users IDs that got email: @uids.&#39;</span><span class="p">,</span> <span class="nv">$params</span><span class="p">),</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>Note the code comments - you are expected to replace foo<em>get</em>digest<em>users() and foo</em>process_digest(). Btw, in those functions, I’ve added debug messages like this.</p>
<div class="highlight"><pre><code class="php language-php" data-lang="php"><span class="cp">&lt;?php</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;drush_log&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">drush_get_option</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">drush_log</span><span class="p">(</span><span class="nx">dt</span><span class="p">(</span><span class="s1">&#39;Digest email to user @uid could not be sent&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;@uid&#39;</span> <span class="o">=&gt;</span> <span class="nv">$account</span><span class="o">-&gt;</span><span class="na">uid</span><span class="p">)),</span> <span class="s1">&#39;ok&#39;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>
<p>After that, all you need to do is create a new Jenkins job.
<img src="/assets/images/legacy/digest_dev_Config_Jenkins.jpg" /></p>

<p><a href="http://getpantheon.com">Pantheon</a> gives us this flexibility, here&#39;s the console log:
<img src="/assets/images/legacy/digest-console.jpg" /></p>

<p>Don&#39;t forget to use <a href="http://drupal.org/project/reroute_email">Reroute email</a> so your users don’t get dummy emails form your Dev and Test environments.</p>


          </div>
        </article>
        <section class="post-nav">
          <div class="row">
            <div class="col-xs-6 previous">
              
              <div class="text-uppercase">
                <a href="/content/message-notify-multilingual-email-notifications/">
                  Previous
                  <span class="visible-xs"> post</span>
                </a>
              </div>
              <a href="/content/message-notify-multilingual-email-notifications/" class="prev-text">
                <span class="hidden-xs">Message notify - Multilingual email notifications</span>
              </a>
              
            </div>
            <div class="col-xs-6 next">
              
              <div class="text-uppercase">
                <a href="/content/commerce-product-subform/">
                  Next
                  <span class="visible-xs"> post</span>
                </a>
              </div>
              <a href="/content/commerce-product-subform/" class="next-text">
                <span class="hidden-xs">Commerce product + Subform</span>
              </a>
              
            </div>
          </div>
        </section>
        <section class="author-details">
          <div class="image-wrapper">
            <img src="/images/team/avatars/amitaibu.4179.jpg" class="img-circle img-responsive">
          </div>
          <div class="text-wrapper">
            <span class="name">Amitai Burstein</span>
            
              <span class="twitter">(@amitaibu)</span>
            
            <div class="title">CTO, Co-Owner</div>
            <div class="bio">Maintainer of Organic groups, the Message stack, and co-maintainer of Drupal 8's Entity reference. <a href="/content/the-about-story/">The about story</a>.</div>
          </div>
        </section>
        <section>
          <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'gizra';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </section>
      </div>
    </div>
  </div>
</div>


    <!--Footer -->
    
  <div id="contact">
    <footer id="footer">
      <div class="footer-wrapper">
        <div class="background">
          <div class="container">
            <div class="row">
              <div class="col-sm-12 narrow">
                <h2 class="title">Talk to us</h2>
                <div class="clearfix">
                  <address>
                    <div class="strong">Israel Headquarters</div>
                    <span>5 Brenner St., Tel Aviv</span>
                    <a class="telephone" href="tel:+97233731222">+972-3-3731222</a>
                    <a class="email" href="mailto:info@gizra.com">info@gizra.com</a>
                  </address>
                  <address class="separator">
                    <div class="strong">United States Office</div>
                    <span>120 W 105th St., New York, NY 10025</span>
                    <a class="telephone" href="tel:+13476864508">+1 347 686-4508</a>
                    <a class="email" href="mailto:usoffice@gizra.com">usoffice@gizra.com</a>
                  </address>
                  <div class="separator social-links">
                  <span class="link twitter">
                  <a href="https://twitter.com/gizra_drupal" target="_blank"><i class="fa fa-twitter-square"></i></a>
                  </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>



    <script src="/js/plugins.f180.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>

    <script src="/js/scripts.e6d0.js"></script>

    </body>
</html>
